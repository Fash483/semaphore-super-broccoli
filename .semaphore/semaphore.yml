version: v1.0
name: Recursive B2 Upload CI

agent:
  machine:
    type: e1-standard-2
blocks:
  - name: Download Torrent
    task:
      jobs:
        - name: Download Files
          commands:
            - echo "Downloading torrent..."
            - mkdir -p downloads
            - sudo apt update -y 
            - sudo apt install -y nodejs npm python3 python3-pip
            - npx webtorrent "magnet:?xt=urn:btih:362fc02c9bdc4b5f2d0fc1f90b34671afa813dbc&dn=Stalked%20by%20My%20Amish%20Boyfriend%202024%201080p%20AMZN%20WEB-DL%20DDP2%200%20H%20264-ZdS&tr=udp://tracker.bittor.pw:1337/announce&tr=udp://tracker.opentrackr.org:1337/announce&tr=udp://tracker.dler.org:6969/announce&tr=udp://open.stealth.si:80/announce&tr=udp://tracker.torrent.eu.org:451/announce&tr=udp://exodus.desync.com:6969/announce&tr=udp://open.demonii.com:1337/announce" --out downloads

  - name: Upload Files to B2
    task:
      # Install Python dependencies
      jobs:
        - name: Install Python and B2 SDK
          commands:
            - echo "Installing Python and dependencies..." 
            - pip install b2sdk

        - name: Upload Files Recursively
          commands:
            - echo "Uploading files to B2..."
            - |
              # Activate venv
              source venv/bin/activate
              # Create upload script inline
              python3 - <<EOF
              import os
              from b2sdk.v2 import *

              # Initialize B2 API
              info = InMemoryAccountInfo()
              b2_api = B2Api(info)

              # Authorize with your credentials
              b2_api.authorize_account("production", "005e0e146db57d50000000001", "K005LdurEh/NDp4F7k8oAo/hBO2+dqE")

              # Specify your bucket name
              bucket_name = 'justine2'
              bucket = b2_api.get_bucket_by_name(bucket_name)

              # Directory to upload
              directory = 'downloads/'

              def upload_file(file_path, relative_path):
                  with open(file_path, 'rb') as file:
                      print(f"Uploading {relative_path}...")
                      bucket.upload_bytes(
                          data=file.read(),
                          file_name=relative_path
                      )

              for root, dirs, files in os.walk(directory):
                  for filename in files:
                      file_path = os.path.join(root, filename)
                      relative_path = os.path.relpath(file_path, start=directory)
                      upload_file(file_path, relative_path)
              EOF
